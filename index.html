<!DOCTYPE html>  
<html lang="es">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>Directorio de Prestadores M√©dicos</title>  
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">  
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>  
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>  
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>  
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>  
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>  
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>  
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>  
    <style>  
        :root {  
            --bg-color: #f5f5f5;  
            --text-color: #000;  
            --header-color: #497e76;  
            --border-color: #497e76;  
            --filter-bg: #f9f9f9;  
            --practice-bg: #e8f4f8;  
            --universal-bg: #e6f7e6;  
            --superador-bg: #f0e6ff;  
            --details-bg: #f9f9f9;  
            --button-bg: #497e76;  
            --reset-bg: #8c4a4a;  
            --chart-bg: #fff;  
            --chart-text: #000;  
        }  
        body.dark-mode {  
            --bg-color: #1e1e1e;  
            --text-color: #fff;  
            --header-color: #76b8a8;  
            --border-color: #76b8a8;  
            --filter-bg: #2c2c2c;  
            --practice-bg: #3a4f5a;  
            --universal-bg: #2a4d2a;  
            --superador-bg: #4d3a5e;  
            --details-bg: #2c2c2c;  
            --button-bg: #76b8a8;  
            --reset-bg: #b85a5a;  
            --chart-bg: #333;  
            --chart-text: #fff;  
        }  
        body {  
            font-family: Arial, sans-serif; margin:20px; background:var(--bg-color); color:var(--text-color); position: relative; min-height: 100vh; transition: background 0.3s;  
        }  
        h1 { color: var(--header-color); }  
        .filtros-container {   
            margin-bottom: 20px;   
            display: flex;   
            gap: 30px;  
            flex-wrap: wrap;  
        }  
        .filtros-group {  
            flex: 1;  
            min-width: 300px;  
            padding: 15px;  
            border: 1px solid var(--border-color);  
            border-radius: 6px;  
            background: var(--filter-bg);  
        }  
        .filtros-group h3 {  
            margin-top: 0;  
            color: var(--header-color);  
        }  
        .filtros {   
            display: flex;   
            gap: 10px;   
            flex-wrap: wrap;  
            align-items: center;  
        }  
        select, button {   
            padding: 8px;   
            border-radius:4px;   
            border:1px solid #bbb;  
            background: var(--filter-bg); color: var(--text-color);  
        }  
        .filtros button {   
            background:var(--button-bg);   
            color:white;   
            border:none;   
            min-width:120px;  
        }  
        .filtros .reset-btn {   
            background: var(--reset-bg);   
        }  
        table { font-size: 14px; }  
        th, td {   
            text-align: center;   
            padding: 4px 8px !important;   
            height: 28px !important; color: var(--text-color);  
        }  
        .dataTable thead .sorting,   
        .dataTable thead .sorting_asc,   
        .dataTable thead .sorting_desc {  
            background-image: none !important;  
        }  
        .details-child { background: var(--details-bg); padding: 18px; color: var(--text-color); border-top: 2px solid var(--border-color); }  
        .details-child table { width: 100%; border-collapse: collapse; }  
        .details-child th, .details-child td { border: 1px solid var(--border-color); padding: 8px; color: var(--text-color); }  
        .details-child th { background: var(--filter-bg); }  
        .details-child td { background: var(--details-bg); }  
        .practices-container {   
            display: flex;   
            flex-wrap: wrap;   
            gap: 15px;   
        }  
        .practice-type-container {   
            flex: 1 0 300px;   
            background: var(--practice-bg);  
            padding: 10px;   
            border-radius: 6px; color: var(--text-color);  
        }  
        .practice-type-title {   
            font-weight: bold;   
            margin-bottom: 8px;   
            text-align: center;  
            color: var(--header-color);  
        }  
        .practice-list {   
            padding-left: 20px;   
            text-align: left; color: var(--text-color);  
        }  
        .map-container {   
            height: 220px;   
            width: 99%;   
            margin-top:10px;   
            border-radius:6px;   
            border:1px solid var(--border-color);  
        }  
        tr.universal { background-color: var(--universal-bg) !important; }  
        tr.superador { background-color: var(--superador-bg) !important; }  
        tr.universal td:first-child { background-color: var(--universal-bg) !important; }  
        tr.superador td:first-child { background-color: var(--superador-bg) !important; }  
        .search-container {  
            display: flex;  
            justify-content: center;  
            margin-bottom: 20px;  
            gap: 10px;  
        }  
        .search-container input {  
            padding: 8px;  
            border-radius: 4px;  
            border: 1px solid #bbb;  
            width: 300px; background: var(--filter-bg); color: var(--text-color);  
        }  
        .search-container button {  
            background: var(--reset-bg);  
            color: white;  
            border: none;  
            padding: 8px 15px;  
            border-radius: 4px;  
            cursor: pointer;  
        }  
        .search-container button:disabled {  
            background: #cccccc;  
            cursor: not-allowed;  
        }  
        .visitor-counter {  
            position: fixed;  
            bottom: 15px;  
            left: 15px;  
            background: rgba(73, 126, 118, 0.95);  
            color: white;  
            padding: 10px 14px;  
            border-radius: 8px;  
            font-size: 13px;  
            z-index: 1000;  
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);  
            text-align: center;  
            border: 2px solid #3a6159;  
            font-weight: bold;  
            display: flex;  
            align-items: center;  
            gap: 8px;  
        }  
        .visitor-counter img {  
            vertical-align: middle;  
            height: 20px;  
        }  
        .dataTables_filter {  
            display: none !important;  
        }  
        .theme-toggle {  
            position: absolute;  
            top: 20px;  
            right: 20px;  
            background: none;  
            border: none;  
            cursor: pointer;  
            font-size: 24px;  
        }  
        .modal {  
            display: none;  
            position: fixed;  
            z-index: 1001;  
            left: 0;  
            top: 0;  
            width: 100%;  
            height: 100%;  
            overflow: auto;  
            background-color: rgba(0,0,0,0.5);  
        }  
        .modal-content {  
            background: var(--bg-color);  
            margin: 5% auto;  
            padding: 20px;  
            border: 1px solid var(--border-color);  
            width: 90%;  
            max-width: 800px;  
            border-radius: 8px;  
            position: relative; color: var(--text-color);  
        }  
        .close-btn {  
            position: absolute;  
            top: 10px;  
            right: 20px;  
            font-size: 28px;  
            cursor: pointer;  
            color: var(--text-color);  
        }  
        #stats-summary { margin-bottom: 20px; text-align: center; font-size: 16px; }  
        #stats-container { display: flex; flex-direction: column; gap: 20px; align-items: center; }  
        #stats-container canvas { max-width: 300px; width: 100%; height: 200px; background: var(--chart-bg); }  
        .loader { display: none; text-align: center; padding: 20px; color: var(--text-color); }  
        .mode-buttons {  
            display: flex;  
            justify-content: center;  
            gap: 10px;  
            margin-bottom: 20px;  
        }  
        .mode-buttons button {  
            background: var(--button-bg);  
            color: white;  
            border: none;  
            padding: 8px 15px;  
            border-radius: 4px;  
            cursor: pointer;  
        }  

        /* === NUEVO: estilos para el modal de mapa general === */  
        #map-modal-content {  
            max-width: 1000px;  
        }  
        #general-map {  
            width: 100%;  
            height: 500px;  
            border-radius: 8px;  
            border: 1px solid var(--border-color);  
        }  
        .map-legend {  
            margin-top: 10px;  
            font-size: 13px;  
            display: flex;  
            flex-wrap: wrap;  
            gap: 10px;  
        }  
        .map-legend-item {  
            display: flex;  
            align-items: center;  
            gap: 5px;  
        }  
        .legend-color-box {  
            width: 14px;  
            height: 14px;  
            border-radius: 3px;  
            border: 1px solid #555;  
        }
        /* --- Formulario de contacto --- */
        #contactForm { max-width:500px; margin:auto; padding:1rem; background-color: #333; border: 1px solid var(--border-color); }
        #contactForm label{ display:block; margin-top:.75rem; font-weight:bold; }
        #contactForm input, #contactForm textarea{
            width:100%; padding:.5rem; border:1px solid #cccccc93; background-color: #cccccc93 ;
            border-radius:4px; box-sizing:border-box;
        }
        #contactForm button{ margin-top:1rem; padding:.75rem 1.5rem; background:#007bff; color:#fff; border:none; cursor:pointer; }
        #contactForm button:hover{ background:#0056b3; }

        /* --- Estilos de los modales (si no los ten√≠as) --- */
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; overflow:auto;
                background-color:rgba(0,0,0,.4); z-index:1000;}
        .modal-content{ background:#1e1e1e; margin:10% auto; padding:1rem; border: 1px solid var(--border-color); border-radius:.5rem; max-width:90%;
                        box-shadow:0 2px 8px rgba(0,0,0,.3);}
        .modal-header { display:flex; justify-content:space-between; align-items:center; }
        .modal-title{ font-size:1.25rem; margin:0;}
        .close-btn{ background:none; border:none; font-size:1.5rem; cursor:pointer; color:#aaa;}
        
    </style>  
</head>  
<body>  
    <button class="theme-toggle" id="theme-toggle">‚òÄÔ∏è</button>  
    <h1>Tabla de Prestadores M√©dicos</h1>  
    
    <div class="search-container">
        <input type="text" id="search-input" placeholder="Buscar por Nombre, Nro Prestador, Seccional o Localidad...">
        <button id="clear-all-btn" disabled>Borrar todo</button>
    </div>

    <div class="mode-buttons">
        <button id="stats-btn">Ver Estad√≠sticas</button>
        <button id="map-btn">Ver Mapa de Prestadores</button>
    </div>

    <div class="filtros-container">
        <div class="filtros-group">
            <h3>Filtros por Clasificaci√≥n</h3>
            <div class="filtros">
                <label>Seccional:
                    <select id="filtro-seccional"><option value="">Todas</option></select>
                </label>
                <label>Clasificaci√≥n:
                    <select id="filtro-clasificacion"><option value="">Todas</option></select>
                </label>
                <label>Plan:
                    <select id="filtro-plan"><option value="">Todos</option></select>
                </label>
                <button id="apply-btn-plan" type="button">Aplicar</button>
            </div>
        </div>

        <div class="filtros-group">
            <h3>Filtros por Especialidad</h3>
            <div class="filtros">
                <label>Seccional:
                    <select id="filtro-seccional-esp"><option value="">Todas</option></select>
                </label>
                <label>Tipo de Prestador:
                    <select id="filtro-tipo"><option value="">Todos</option></select>
                </label>
                <label>Especialidad:
                    <select id="filtro-especialidad"><option value="">Todas</option></select>
                </label>
                <button id="apply-btn-esp" type="button">Aplicar</button>
            </div>
        </div>
    </div>
    
    <table id="tabla-prestadores" class="display" style="width:100%;">  
        <thead>  
            <tr>  
                <th></th>  
                <th>Nombre</th>  
                <th>Nro Prestador</th>  
                <th>Seccional</th>  
                <th>Localidad</th>  
                <th>Plan</th>  
            </tr>  
        </thead>  
        <tbody></tbody>  
    </table>

    <div class="visitor-counter" id="visitor-counter">
        <span>üë• Visitas:</span>
        <img id="counter-img" src="https://visitor-badge.laobi.icu/badge?page_id=prestadores-medicos.2024&left_color=gray&right_color=green&left_text=Visitas" alt="visitas"/>
    </div>

    <div id="stats-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="close-stats">&times;</span>
            <h2>Estad√≠sticas de Prestadores</h2>
            <div id="stats-summary"></div>
            <div id="stats-container">
                <canvas id="seccional-chart"></canvas>
                <canvas id="plan-chart"></canvas>
                <canvas id="clasificacion-chart"></canvas>
            </div>
        </div>
    </div>

    <div id="map-modal" class="modal">
        <div class="modal-content" id="map-modal-content">
            <span class="close-btn" id="close-map">&times;</span>
            <h2>Mapa de Prestadores (seg√∫n filtros actuales)</h2>
            <div id="general-map"></div>
            <div class="map-legend">
                <div class="map-legend-item">
                    <div class="legend-color-box" style="background:#E74C3C;"></div> Clinicas y Sanatorios
                </div>
                <div class="map-legend-item">
                    <div class="legend-color-box" style="background:#B5E6A2;"></div> Diagnostico y Tratamiento
                </div>
                <div class="map-legend-item">
                    <div class="legend-color-box" style="background:#27AE60;"></div> Rehabilitacion
                </div>
                <div class="map-legend-item">
                    <div class="legend-color-box" style="background:#F1C40F;"></div> Centros Medicos
                </div>
                <div class="map-legend-item">
                    <div class="legend-color-box" style="background:#E67E22;"></div> Especialistas
                </div>
                <div class="map-legend-item">
                    <div class="legend-color-box" style="background:#3498DB;"></div> Pediatria
                </div>
                <div class="map-legend-item">
                    <div class="legend-color-box" style="background:#9B59B6;"></div> Salud Mental
                </div>
                <div class="map-legend-item">
                    <div class="legend-color-box" style="background:#afb3b0;"></div> Varios
                </div>

                
            </div>
            <div style="margin-top:10px;font-size:12px;opacity:.9;">
                Nota: Este mapa esta en version Beta y algunas ubicaciones no aparecen. Se iran agregando las faltantes.
            </div>
        </div>
    </div>


    <!-- ==================== BOT√ìN QUE ABRE EL MODAL ==================== -->
    <div style="text-align:center; margin-top:2rem;">
        <button id="openContactBtn"
                style="padding:.75rem 1.5rem;background:#497e76;color:white;border: 2px solid #3a6159;
                    border-radius:.25rem;font-size:1rem;cursor:pointer;">
            Ingresar Reclamo
        </button>
    </div>

    <!-- ==================== MODAL CON EL FORMULARIO ==================== -->
    <div id="contact-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
            <h2 class="modal-title">Cont√°ctanos</h2>
            <button type="button" class="close-btn" aria-label="Cerrar">&times;</button>
        </div>

            <!-- Formulario -->
        <form id="contactForm">
            <label>Nombre:
                <input type="text" name="name" required />
            </label>
            <label>Email:
                <input type="email" name="email" required />
            </label>
            <label>Mensaje:
                <textarea name="message" rows="4" required></textarea>
            </label>
            <button type="submit">Enviar</button>
        </form>
    </div>

<script src="https://cdn.jsdelivr.net/npm/emailjs-com@2/dist/email.min.js"></script>
<script>

// ============================================================
// MODO OSCURO
// ============================================================
const themeToggle = document.getElementById('theme-toggle');
const body = document.body;
const currentTheme = localStorage.getItem('theme') || 'light';
if (currentTheme === 'dark') {
    body.classList.add('dark-mode');
    themeToggle.innerHTML = 'üåô';
} else {
    themeToggle.innerHTML = '‚òÄÔ∏è';
}

let tabla; // (antes estaba dentro del closure; lo dejamos accesible)
let seccionalChart, planChart, clasificacionChart;

themeToggle.addEventListener('click', () => {
    body.classList.toggle('dark-mode');
    const isDark = body.classList.contains('dark-mode');
    themeToggle.innerHTML = isDark ? 'üåô' : '‚òÄÔ∏è';
    localStorage.setItem('theme', isDark ? 'dark' : 'light');

    if (seccionalChart) seccionalChart.update();
    if (planChart) planChart.update();
    if (clasificacionChart) clasificacionChart.update();

    if (tabla) {
        tabla.rows().every(function() {
            if (this.child.isShown()) {
                this.child.hide();
                this.nodes().to$().removeClass('shown');
            }
        });
    }
});

// ============================================================
// C√ìDIGO ORIGINAL + MAPA GENERAL SIN GEOCODING
// ============================================================
const tipoEspecialidad = {  
    "GuardiaActiva": ["Cardiologica","Clinica","General","Ginecologica","Obstetrica","Odontologica","Oftalmologica","Otorrinolaringologia","Pediatrica","Por Electrocucion","Por envenenamiento","Por intoxicacion","Por mordedura de animales","Psiquiatrica","Quemados","Quirurgica","Traumatologica"],  
    "GuardiaPasiva": ["Cardiologica","Clinica","General","Ginecologica","Obstetrica","Oftalmologica","Otorrinolaringologia","Pediatrica","Psiquiatrica","Quemados","Quirurgica","Traumatologica"],  
    "EspecialidadesAmbulatorio": ["Adolescencia","Alergia e Inmunologia","Alergia e Inmunologia Infantil","Andrologia","Cardiologia","Cardiologia Infantil","Clinica Medica","Dermatologia","Dermatologia Infantil","Diabetologia","Diabetologia Infantil","Endocrinologia","Endocrinologia Infantil","Estomatologia","Fisiatria","Flebologia y Linfologia","Fonoaudiologia","Gastroenterologia","Gastroenterologia Infantil","Genetica","Geriatria","Ginecologia","Ginecologia Infanto Juvenil","Hematologia e Inmunologia","Hematologia e Inmunologia Infantil","Hemodinamia","Hemoterapia","Hemoterapia Infantil","Hepatologia","Infectologia","Infectologia Infantil","Kinesiologia","Medicina Familiar","Micologia","Nefrologia","Nefrologia Infantil","Neonatologia","Neumonologia","Neumonologia Infantil","Neurocirugia","Neurologia","Neurologia Infantil","Nutricion","Nutricion Infantil","Obstetricia","Odontologia","Oftalmologia","Oftalmologia Infantil","Oncologia","Oncologia Infantil","Osteoporosis y Litiasis renal","Otorrinolaringologia","Otorrinolaringologia Infantil","Patologia Mamaria","Pediatria","Proctologia","Psicologia","Psicopedagogia","Psiquiatria","Psiquiatria Infantil","Quemados","Reumatologia","Traumatologia y Ortopedia","Traumatologia y Ortopedia Infantil","Urologia","Urologia Infantil"],  
    "Internacion": ["Internacion Cardiologica","Internacion Neurologia","Internacion Oftalmologica","Internacion Otorrinolaringologica","Internacion por Rehabilitacion","Internacion Psiquiatrica","Internacion Traumatologica","Maternidad","Pediatrica","Piso","Respirador","Telemetria","Terapia Intermedia","UCO","UTI","UTINeo","UTIP"],  
    "Cirugias": ["Artroscopica","Cabeza y Cuello","Cardiaca","Cardiaca Infantil","Endoscopica","General","Ginecologia","Infantil","Laparoscopica","Miembro Superior y Mano","Nariz y oido","Neurocirugia","Oftalmologica","Pierna y Pie","Plastica Reparadora","Toracica","Urologia","Vascular Periferica"],  
    "DiagnosticoyTratamiento": ["Anatomia Patologia","Audiometria","Camara Gamma - Medicina Nuclear - Radioisotopos","Campo visual computarizado","Colposcopia","Densitometria Osea","Drenaje Linfatico","Eco-Doppler","Ecografia","Ecografia Infantil","Eco Estres","Electrocardiograma","Electroencefalograma","Electromiograma","Endoscopia Digestiva","Ergometria","Espinograma","Espirometria","Espirometria Infantil","Estudios mamarios","Holter","Infiltraciones","Laboratorio","Mapeo Cerebral","Monitoreo Fetal","PET","Polisomnografia","Potenciales Evocados","Presurometria","Psicoprofilaxis del parto","Puncion Mamaria","Puncion Tiroide","Radiologia","Radiologia Infantil","Rehabilitacion Vestibular","Resonancia Magnetica Nuclear","RPG","Tomografia Computada","Urodinamia","Urodinamia Infantil"]  
};  
const seccionales = ["BAHIA BLANCA","BUENOS AIRES ZONA 1","BUENOS AIRES ZONA 2","BUENOS AIRES ZONA 3","CAPITAL","CATAMARCA","CHACO","CHUBUT","CORDOBA","CORRIENTES","ENTRE RIOS","FORMOSA","GBA NOROESTE","GBA NORTE","GBA OESTE","GBA SUR","JUJUY","LA PAMPA","LA PLATA","LA RIOJA","MAR DEL PLATA","MENDOZA","MISIONES","NEUQUEN","RIO NEGRO","ROSARIO","SALTA","SAN JUAN","SAN LUIS","SANTA CRUZ","SANTA FE","SANTIAGO DEL ESTERO","TIERRA DEL FUEGO","TRENQUE LAUQUEN","TUCUMAN"];  

$(function() {  
    seccionales.forEach(sec => {
        $('#filtro-seccional').append(`<option value="${sec}">${sec}</option>`);
        $('#filtro-seccional-esp').append(`<option value="${sec}">${sec}</option>`);
    });
    
    Object.keys(tipoEspecialidad).forEach(tipo => $('#filtro-tipo').append(`<option value="${tipo}">${tipo}</option>`));  

    let providersCompact = [], datosFiltrados = [];  
    let uniqueClasificaciones = new Set();  

    function updateEspecialidades() {  
        const tipoSeleccionado = $('#filtro-tipo').val();  
        const $filtroEspecialidad = $('#filtro-especialidad');  
        $filtroEspecialidad.empty().append('<option value="">Todas</option>');  

        if (tipoSeleccionado) {  
            tipoEspecialidad[tipoSeleccionado].forEach(especialidad => {  
                $filtroEspecialidad.append(`<option value="${especialidad}">${especialidad}</option>`);  
            });  
        }  
    }  

    $('#filtro-tipo').on('change', function() {  
        updateEspecialidades();  
    });  

    // ============================================================
    // CAMBIO PRINCIPAL: cargar el CSV ya geocodificado
    // ============================================================
    Papa.parse("Data_geocoded.csv", {  
        download: true,  
        header: true,  
        delimiter: ";",  
        complete: function(results) {  

            datosFiltrados = results.data.filter(row => {
                return row.CUIT && row.CUIT.trim() !== "" &&
                    !(row['Clasificacion prestador'] === 'Clinicas y Sanatorios' &&
                        row['Tipo de prestador'] === 'DiagnosticoyTratamiento');
            });
                       
            const providersMap = {};  
            const uniquePlans = new Set();  

            datosFiltrados.forEach(row => {  
                const key = `${row.CUIT}-${row.Domicilio}`;  
                if (!providersMap[key]) {  
                    providersMap[key] = {  
                        CUIT: row.CUIT,  
                        Nombre: row.Nombre,  
                        NroPrestador: row.NroPrestador,  
                        Seccional: row.Seccional,  
                        Provincia: row.Provincia,  
                        Partido: row.Partido,  
                        Localidad: row.Localidad,  
                        Domicilio: row.Domicilio,  
                        Telefono: row.Telefono,  
                        Clasificacion: row['Clasificacion prestador'],  
                        Plan: new Set(),  
                        practices: [],

                        // ============================================================
                        // NUEVO: lat/lon vienen del CSV geocodificado (sin fetch a Nominatim)
                        // ============================================================
                        lat: row.lat ? parseFloat(String(row.lat).replace(",", ".")) : null,
                        lon: row.lon ? parseFloat(String(row.lon).replace(",", ".")) : null
                    };  
                    if (row['Clasificacion prestador']) {  
                        uniqueClasificaciones.add(row['Clasificacion prestador']);  
                    }  
                }  
                if (row.Plan) {  
                    providersMap[key].Plan.add(row.Plan);  
                    uniquePlans.add(row.Plan);  
                }  
                providersMap[key].practices.push({  
                    tipo: row['Tipo de prestador'],  
                    especialidad: row['Especialidad']  
                });  
            });  

            Object.keys(providersMap).forEach(key => {  
                const planStr = Array.from(providersMap[key].Plan).join(', ');  
                providersMap[key].Plan = planStr;  
            });  
            providersCompact = Object.values(providersMap);  

            providersCompact.sort((a, b) => {  
                const aIsUniversal = a.Plan.includes('Universal');  
                const bIsUniversal = b.Plan.includes('Universal');  
                const aIsSuperador = a.Plan.includes('Superador');  
                const bIsSuperador = b.Plan.includes('Superador');  

                if (aIsUniversal && !bIsUniversal) return -1;  
                if (!aIsUniversal && bIsUniversal) return 1;  
                if (aIsSuperador && !bIsSuperador) return 1;  
                if (!aIsSuperador && bIsSuperador) return -1;  
                return a.Nombre.localeCompare(b.Nombre);  
            });  

            uniqueClasificaciones.forEach(clasif => $('#filtro-clasificacion').append(`<option value="${clasif}">${clasif}</option>`));  
            uniquePlans.forEach(plan => $('#filtro-plan').append(`<option value="${plan}">${plan}</option>`));  

            function getCurrentFilters() {  
                let filters = [];  
                const seccional = $('#filtro-seccional').val();  
                if (seccional) filters.push(`Seccional: ${seccional}`);  
                const clasificacion = $('#filtro-clasificacion').val();  
                if (clasificacion) filters.push(`Clasificaci√≥n: ${clasificacion}`);  
                const plan = $('#filtro-plan').val();  
                if (plan) filters.push(`Plan: ${plan}`);  
                const seccionalEsp = $('#filtro-seccional-esp').val();  
                if (seccionalEsp) filters.push(`Seccional Esp: ${seccionalEsp}`);  
                const tipo = $('#filtro-tipo').val();  
                if (tipo) filters.push(`Tipo: ${tipo}`);  
                const especialidad = $('#filtro-especialidad').val();  
                if (especialidad) filters.push(`Especialidad: ${especialidad}`);  
                const search = $('#search-input').val();  
                if (search) filters.push(`B√∫squeda: ${search}`);  
                return filters.length > 0 ? 'Filtros aplicados: ' + filters.join(', ') : 'Sin filtros aplicados';  
            }  

            tabla = $('#tabla-prestadores').DataTable({  
                data: providersCompact.filter(provider => {
                    return !(provider.Clasificacion === 'Clinicas y Sanatorios' &&
                            provider.practices.some(p => p.tipo === 'DiagnosticoyTratamiento'));
                }),  
                columns: [  
                    {data: null, defaultContent: '<button class="details-control">+</button>', orderable: false },  
                    {data: 'Nombre', defaultContent: '' },  
                    {data: 'NroPrestador', defaultContent: '' },  
                    {data: 'Seccional', defaultContent: '' },  
                    {data: 'Localidad', defaultContent: '' },  
                    {data: 'Plan', defaultContent: '' }  
                ],  
                language: {url: 'https://cdn.datatables.net/plug-ins/1.11.5/i18n/es-ES.json'},  
                pageLength: 25,  
                ordering: false,  
                searching: true,  
                dom: 'Bfrtip',  
                buttons: [  
                    { extend: 'copyHtml5', title: () => 'Prestadores M√©dicos - ' + getCurrentFilters() },  
                    { extend: 'excelHtml5', title: () => 'Prestadores M√©dicos - ' + getCurrentFilters() },  
                    { extend: 'csvHtml5', title: () => 'Prestadores M√©dicos - ' + getCurrentFilters() },  
                    { extend: 'pdfHtml5', title: () => 'Prestadores M√©dicos - ' + getCurrentFilters(), messageTop: () => getCurrentFilters() }  
                ],  
                createdRow: function(row, data) {  
                    if (data.Plan.includes('Universal')) {  
                        $(row).addClass('universal');  
                    } else if (data.Plan.includes('Superador')) {  
                        $(row).addClass('superador');  
                    }  
                },  
                drawCallback: function() {  
                    $('tr.universal td:first-child').css('background-color', 'var(--universal-bg)');  
                    $('tr.superador td:first-child').css('background-color', 'var(--superador-bg)');  
                    updateClearAllButton();  
                }  
            });  

            $('#search-input').on('keyup', function() {  
                tabla.search(this.value).draw();  
                updateClearAllButton();  
            });  

            $('#clear-all-btn').click(function() {  
                $('#filtro-seccional, #filtro-clasificacion, #filtro-plan, #filtro-seccional-esp, #filtro-tipo, #filtro-especialidad').val('');  
                $('#search-input').val('');  
                updateEspecialidades();  
                tabla.search('').draw();  
                tabla.clear().rows.add(providersCompact).draw();  
                updateClearAllButton();  
            });  

            $('#apply-btn-plan').click(function() {  
                filterTableByPlan();  
                updateClearAllButton();  
            });  
            
            $('#apply-btn-esp').click(function() {  
                filterTableBySpecialty();  
                updateClearAllButton();  
            });  

            function updateClearAllButton() {  
                const hasFilters =  
                    $('#filtro-seccional').val() ||  
                    $('#filtro-clasificacion').val() ||  
                    $('#filtro-plan').val() ||  
                    $('#filtro-seccional-esp').val() ||  
                    $('#filtro-tipo').val() ||  
                    $('#filtro-especialidad').val() ||  
                    $('#search-input').val();  
                $('#clear-all-btn').prop('disabled', !hasFilters);  
            }  

            function filterTableByPlan() {  
                const seccional = $('#filtro-seccional').val();  
                const clasificacion = $('#filtro-clasificacion').val();  
                const plan = $('#filtro-plan').val();  

                const filteredData = providersCompact.filter(provider => {  
                    if(provider.Clasificacion === 'Clinicas y Sanatorios' &&  
                        provider.practices.some(p=> p.tipo === 'DiagnosticoyTratamiento')){  
                        return false;  
                    }  
                      
                    if (seccional && provider.Seccional !== seccional) return false;  
                    if (clasificacion && provider.Clasificacion !== clasificacion) return false;  
                    if (plan && !provider.Plan.includes(plan)) return false;  
                    return true;  
                });  

                tabla.clear().rows.add(filteredData).draw();  
            }  

            function filterTableBySpecialty() {  
                const seccional = $('#filtro-seccional-esp').val();  
                const tipo = $('#filtro-tipo').val();  
                const especialidad = $('#filtro-especialidad').val();  

                const filteredData = providersCompact.filter(provider => {  
                    if (provider.Clasificacion === 'Clinicas y Sanatorios' &&  
                       provider.practices.some(p=> p.tipo === 'DiagnosticoyTratamiento')) {  
                        return false;  
                    }  

                    if (seccional && provider.Seccional !== seccional) return false;  
                    if (tipo) {  
                        const hasPracticeType = provider.practices.some(p => p.tipo === tipo);  
                        if (!hasPracticeType) return false;  
                    }  
                    if (especialidad) {  
                        const hasSpecialty = provider.practices.some(p => p.especialidad === especialidad);  
                        if (!hasSpecialty) return false;  
                    }  
                    return true;  
                });  

                tabla.clear().rows.add(filteredData).draw();  
            }  

            // ============================================================
            // DETALLE: MAPA INDIVIDUAL SIN GEOCODING
            // (usa rowData.lat / rowData.lon del CSV)
            // ============================================================
            $('#tabla-prestadores tbody').on('click', 'button.details-control', function () {  
                const tr = $(this).closest('tr');  
                const row = tabla.row(tr);  
                const rowData = row.data();  

                if (row.child.isShown()) {  
                    row.child.hide();  
                    tr.removeClass('shown');  
                    $(this).text('+');  
                } else {  
                    $(this).text('-');  
                    const practicesByType = {};  
                      
                    rowData.practices.forEach(practice => {  
                        if(!(rowData.Clasificacion === 'Clinicas y Sanatorios' && practice.tipo === 'DiagnosticoyTratamiento')){  
                            if (!practicesByType[practice.tipo]) {  
                                practicesByType[practice.tipo] = [];  
                            }  
                            practicesByType[practice.tipo].push(practice.especialidad);   
                        }   
                    });  

                    let practicesHtml = '<div class="practices-container">';  
                    Object.keys(practicesByType).forEach(tipo => {  
                        practicesHtml += `  
                        <div class="practice-type-container">  
                            <div class="practice-type-title">${tipo}</div>  
                            <ul class="practice-list">`;  
                        practicesByType[tipo].forEach(especialidad => {  
                            practicesHtml += `<li>${especialidad}</li>`;  
                        });  
                        practicesHtml += `  
                            </ul>  
                        </div>`;  
                    });  
                    practicesHtml += '</div>';  

                    const mapId = `mapa-${(rowData.CUIT).replace(/\\W/g,'')}-${(rowData.Domicilio).replace(/\\W/g,'')}`;  
                    let detalleHtml = `  
                    <div class="details-child">  
                        <table class="details-table">  
                            <tr><th>Provincia:</th><td>${rowData.Provincia||'N/A'}</td></tr>  
                            <tr><th>Partido:</th><td>${rowData.Partido||'N/A'}</td></tr>  
                            <tr><th>Localidad:</th><td>${rowData.Localidad||'N/A'}</td></tr>  
                            <tr><th>Domicilio:</th><td>${rowData.Domicilio||'N/A'}</td></tr>  
                            <tr><th>Telefono:</th><td>${rowData.Telefono||'N/A'}</td></tr>  
                            <tr><th>Clasificaci√≥n:</th><td>${rowData.Clasificacion||'N/A'}</td></tr>  
                            <tr><th>Pr√°cticas:</th><td>${practicesHtml}</td></tr>  
                            <tr><th>Ubicaci√≥n:</th>  
                                <td>  
                                    <div id="${mapId}" class="map-container"></div>  
                                </td>  
                            </tr>  
                        </table>  
                    </div>`;  
                    row.child(detalleHtml).show();  
                    tr.addClass('shown');  

                    const hasCoords =
                        rowData.lat != null && rowData.lon != null &&
                        !isNaN(rowData.lat) && !isNaN(rowData.lon);

                    if (hasCoords) {
                        const map = L.map(mapId).setView([rowData.lat, rowData.lon], 16);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: 'OpenStreetMap'}).addTo(map);
                        const address = [rowData.Domicilio, rowData.Localidad, rowData.Partido, rowData.Provincia].filter(Boolean).join(", ");
                        L.marker([rowData.lat, rowData.lon]).addTo(map).bindPopup(address).openPopup();
                    } else {
                        document.getElementById(mapId).innerHTML =
                            "<div style='color:#b71c1c;padding:30px;text-align:center;'>Sin coordenadas (lat/lon) en Data_geocoded.csv.</div>";
                    }
                }  
            });  

            // ============================================================  
            // MODAL PARA ESTAD√çSTICAS (igual)
            // ============================================================  
            const statsModal = document.getElementById('stats-modal');  
            const statsBtn = document.getElementById('stats-btn');  
            const closeStats = document.getElementById('close-stats');  

            statsBtn.onclick = function() {  
                statsModal.style.display = 'block';  
                const filteredData = tabla.rows({search: 'applied'}).data().toArray();  
                const isDark = body.classList.contains('dark-mode');  

                const totalPrestadores = filteredData.length;  
                const universalCount = filteredData.filter(p => p.Plan.includes('Universal')).length;  
                const superadorCount = filteredData.filter(p => p.Plan.includes('Superador')).length;  
                const seccionalCount = {};  
                filteredData.forEach(p => seccionalCount[p.Seccional] = (seccionalCount[p.Seccional] || 0) + 1);  
                const topSeccional = Object.entries(seccionalCount).sort((a, b) => b[1] - a[1])[0] || ['N/A', 0];  
                document.getElementById('stats-summary').innerHTML = `  
                    Total Prestadores: ${totalPrestadores} | Universal: ${universalCount} | Superador: ${superadorCount} |  
                    Top Seccional: ${topSeccional[0]} (${topSeccional[1]})  
                `;  

                const seccionalLabels = Object.keys(seccionalCount);  
                const seccionalData = Object.values(seccionalCount);  
                const chartTextColor = isDark ? '#fff' : '#000';  
                const chartBgColors = seccionalLabels.map(() => isDark ? '#76b8a8' : '#497e76');  

                if (!seccionalChart) {  
                    seccionalChart = new Chart(document.getElementById('seccional-chart'), {  
                        type: 'bar',  
                        data: { labels: seccionalLabels, datasets: [{ label: 'Prestadores por Seccional', data: seccionalData, backgroundColor: chartBgColors }] },  
                        options: { scales: { y: { beginAtZero: true, ticks: { color: chartTextColor } }, x: { ticks: { color: chartTextColor } } }, plugins: { legend: { labels: { color: chartTextColor } } } }  
                    });  
                } else {  
                    seccionalChart.data.labels = seccionalLabels;  
                    seccionalChart.data.datasets[0].data = seccionalData;  
                    seccionalChart.data.datasets[0].backgroundColor = chartBgColors;  
                    seccionalChart.options.scales.y.ticks.color = chartTextColor;  
                    seccionalChart.options.scales.x.ticks.color = chartTextColor;  
                    seccionalChart.options.plugins.legend.labels.color = chartTextColor;  
                    seccionalChart.update();  
                }  

                const planCount = { Universal: universalCount, Superador: superadorCount };  
                const planBgColors = isDark ? ['#3a6159', '#5e3a4d'] : ['#e6f7e6', '#f0e6ff'];  

                if (!planChart) {  
                    planChart = new Chart(document.getElementById('plan-chart'), {  
                        type: 'pie',  
                        data: { labels: ['Universal', 'Superador'], datasets: [{ data: [planCount.Universal, planCount.Superador], backgroundColor: planBgColors }] },  
                        options: { plugins: { legend: { labels: { color: chartTextColor } } } }  
                    });  
                } else {  
                    planChart.data.datasets[0].data = [planCount.Universal, planCount.Superador];  
                    planChart.data.datasets[0].backgroundColor = planBgColors;  
                    planChart.options.plugins.legend.labels.color = chartTextColor;  
                    planChart.update();  
                }  

                const clasificacionCount = {};  
                filteredData.forEach(provider => {  
                    clasificacionCount[provider.Clasificacion] = (clasificacionCount[provider.Clasificacion] || 0) + 1;  
                });  
                const sortedClasif = Object.entries(clasificacionCount).sort((a, b) => b[1] - a[1]).slice(0, 5);  
                const clasifLabels = sortedClasif.map(([key]) => key);  
                const clasifData = sortedClasif.map(([, value]) => value);  
                const clasifBgColors = clasifLabels.map(() => isDark ? '#b85a5a' : '#8c4a4a');  

                if (!clasificacionChart) {  
                    clasificacionChart = new Chart(document.getElementById('clasificacion-chart'), {  
                        type: 'bar',  
                        data: { labels: clasifLabels, datasets: [{ label: 'Top 5 Clasificaciones', data: clasifData, backgroundColor: clasifBgColors }] },  
                        options: { scales: { y: { beginAtZero: true, ticks: { color: chartTextColor } }, x: { ticks: { color: chartTextColor } } }, plugins: { legend: { labels: { color: chartTextColor } } } }  
                    });  
                } else {  
                    clasificacionChart.data.labels = clasifLabels;  
                    clasificacionChart.data.datasets[0].data = clasifData;  
                    clasificacionChart.data.datasets[0].backgroundColor = clasifBgColors;  
                    clasificacionChart.options.scales.y.ticks.color = chartTextColor;  
                    clasificacionChart.options.scales.x.ticks.color = chartTextColor;  
                    clasificacionChart.options.plugins.legend.labels.color = chartTextColor;  
                    clasificacionChart.update();  
                }  
            };  

            closeStats.onclick = function() {  
                statsModal.style.display = 'none';  
            };  

            // ============================================================
            // MAPA GENERAL: SOLO USA lat/lon DEL CSV (sin geocodificar)
            // ============================================================
            const mapModal = document.getElementById('map-modal');
            const mapBtn = document.getElementById('map-btn');
            const closeMap = document.getElementById('close-map');
            let generalMap = null;
            let generalMarkersLayer = null;

            function getColorByClasificacion(clasif) {
                if (!clasif) return '#666666';
                const c = clasif.toLowerCase();
                if (c.includes('clinicas') || c.includes('sanatorio')) return '#E74C3C';
                if (c.includes('diagnostico')) return '#B5E6A2';
                if (c.includes('rehabil')) return '#27AE60';
                if (c.includes('centr')) return '#F1C40F';
                if (c.includes('pedia')) return '#3498DB';
                if (c.includes('especial')) return '#E67E22';
                if (c.includes('salud')) return '#9B59B6';
                if (c.includes('vario')) return '#afb3b0';
                

                return '#666666';
            }

            function createColoredIcon(color) {
                return L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="
                        width:14px;height:14px;border-radius:50%;
                        background:${color};border:2px solid #ffffff;
                        box-shadow:0 0 4px rgba(0,0,0,0.6);"></div>`,
                    iconSize: [14, 14],
                    iconAnchor: [7, 7]
                });
            }

            function buildGeneralMap() {
                const rows = tabla.rows({search:'applied'}).data().toArray();

                if (!generalMap) {
                    generalMap = L.map('general-map').setView([-34.6, -58.4], 4);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: 'OpenStreetMap'
                    }).addTo(generalMap);
                }

                if (generalMarkersLayer) {
                    generalMap.removeLayer(generalMarkersLayer);
                }
                generalMarkersLayer = L.layerGroup().addTo(generalMap);

                const bounds = [];

                for (const provider of rows) {
                    const lat = provider.lat;
                    const lon = provider.lon;

                    if (lat == null || lon == null || isNaN(lat) || isNaN(lon)) {
                        continue; // sin coordenadas, no se muestra
                    }

                    const color = getColorByClasificacion(provider.Clasificacion);
                    const icon = createColoredIcon(color);

                    const popupHtml = `
                        <strong>${provider.Nombre || ''}</strong><br>
                        Clasificaci√≥n: ${provider.Clasificacion || 'N/A'}<br>
                        Seccional: ${provider.Seccional || 'N/A'}<br>
                        Localidad: ${provider.Localidad || 'N/A'}<br>
                        Domicilio: ${provider.Domicilio || 'N/A'}<br>
                        Tel√©fono: ${provider.Telefono || 'N/A'}
                    `;

                    const marker = L.marker([lat, lon], { icon }).bindPopup(popupHtml);
                    marker.addTo(generalMarkersLayer);
                    bounds.push([lat, lon]);
                }

                if (bounds.length > 0) {
                    generalMap.fitBounds(bounds, { padding: [20, 20] });
                }
            }

            mapBtn.onclick = function() {
                mapModal.style.display = 'block';
                // Espera breve para que el div del mapa ya est√© visible (Leaflet lo necesita)
                setTimeout(() => {
                    buildGeneralMap();
                    if (generalMap) generalMap.invalidateSize();
                }, 150);
            };

            closeMap.onclick = function() {
                mapModal.style.display = 'none';
            };

            window.onclick = function(event) {  
                if (event.target == statsModal) statsModal.style.display = 'none';  
                if (event.target == mapModal) mapModal.style.display = 'none';  
            };  
        }  
    });  
});

// ==================== Configuraci√≥n de EmailJS ====================
const serviceID = 'service_bpql0t2';          // <-- REEMPLAZAR
const templateID = 'template_pvy0uye';
const userKey    = 'gGaNST8Xed0QDePFj';        // <-- REEMPLAZAR

emailjs.init(userKey);

// Funci√≥n que env√≠a el correo
function sendEmail(data) {
  const params = {
    name: data.name,
    contact_email: data.email,   // nombre de campo en tu template
    message: data.message,
    time: new Date().toLocaleString()
  };

  emailjs.send(serviceID, templateID, params)
    .then((response) => {
      console.log('‚úÖ Correo enviado:', response.status);
      alert('¬°Mensaje enviado! Gracias por contactarnos.');
      closeModal();            // Cerrar modal despu√©s del env√≠o
    })
    .catch((err) => {
      console.error('‚ùå Error al enviar:', err);
      alert('Hubo un problema. Int√©ntalo de nuevo.');
    });
}
// ------------------- Funciones de apertura/cierre -------------------
const contactModal = document.getElementById('contact-modal');
function openModal() { contactModal.style.display = 'block'; }
function closeModal(){ contactModal.style.display = 'none'; }

document.getElementById('openContactBtn').addEventListener('click', openModal);
document.querySelector('#contact-modal .close-btn')
        .addEventListener('click', closeModal);

// Cerrar modal al hacer click fuera del contenido
window.addEventListener('click', (e) => {
  if (e.target === contactModal) closeModal();
});

// ------------------- Manejo del formulario -------------------
document.getElementById('contactForm').addEventListener('submit', function(e){
  e.preventDefault();                     // Evita recarga

  const formData = new FormData(this);     // Obtiene todos los campos
  const dataObj  = Object.fromEntries(formData.entries()); // Convierte a objeto

  sendEmail(dataObj);
});
</script>  
</body>  
</html>
